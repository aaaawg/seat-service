<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>예약 현황</title>
    <link th:href="@{/css/bootstrap.min.css}"
          href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <button type="button" onclick="showModal()">상태 변경</button>
    <button type="button" th:if="${checkSC}" onclick="showSeatingChart()">좌석 현황</button>
    <table class="table" id="tb">
        <thead>
        <tr>
            <th><input type="checkbox" onclick="checkAll(this)" id="allCheck"></th>
            <th>예약번호</th>
            <th>신청일</th>
            <th>이름</th>
            <th>생년월일</th>
            <th>전화번호</th>
            <th>이메일</th>
            <th th:if="${checkSC}">좌석</th>
            <th>신청서</th>
            <th>상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="booking: ${userList}">
            <td><input name="listCheckbox" type="checkbox" th:disabled="${booking.status} == '취소'"></td>
            <td th:text="${booking.bookingNum}"></td>
            <td th:text="${#dates.format(booking.bookingDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
            <td th:text="${booking.name}"></td>
            <td th:text="${booking.birth}"></td>
            <td th:text="${booking.phone}"></td>
            <td th:text="${booking.email}"></td>
            <td th:if="${checkSC}" th:text="${booking.seatNum}"></td>
            <td><button>보기</button></td>
            <td th:text="${booking.status}"></td>
        </tr>
        </tbody>
    </table>
</div>

<div class="modal" id="updateStatusModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>상태 변경</h5>
            </div>
            <div class="modal-body">
                <form>
                    <select class="form-select" id="status" onchange="setStatusValue(this)">
                        <option selected disabled>예약 상태 변경</option>
                        <option value="예정">예정</option>
                        <option value="참가">참가</option>
                        <option value="불참">불참</option>
                        <option value="취소">취소</option>
                    </select>
                    <br>
                    <div class="form-floating" style="display: none" id="enterReason">
                        <textarea class="form-control" name="reason" id="reason" placeholder="취소 사유를 입력해주세요." style="height: 100px"></textarea>
                        <label for="reason">취소 사유를 입력해주세요.</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <strong id="notification" style="color: #e10000"></strong>
                <button type="button" onclick="updateStatus()">변경하기</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script th:inline="javascript">
    let params = new URLSearchParams(location.search);
    let programNum = [[${programNum}]];
    let viewingDate = params.get("date");
    let viewingTime = params.get("time");

    function showModal() {
        const length = document.querySelectorAll('input[name=listCheckbox]:checked').length;
        if(length > 0)
            $('#updateStatusModal').modal('show');
        else
            alert("예약 정보를 선택하세요.");
    }

    function updateStatus() {
        let c = document.getElementsByName("listCheckbox");
        let row;
        let bookingNumArr = new Array();
        let url = `/business/program/${programNum}/booking?date=${viewingDate}&time=${viewingTime}`;
        let data;
        const selectedStatus = document.getElementById("status").value;

        for (let i = 0; i < c.length; i++) {
            row = c[i].parentNode.parentNode
            if(c[i].checked) {
                bookingNumArr.push(row.cells[1].innerText)
            }
        }

        data = {
            status: selectedStatus,
            bookingNumList: bookingNumArr
        }
        if(document.getElementById("status").value === "취소")
            data['reason'] = document.getElementById("reason").value;

        if(selectedStatus === "예약 상태 변경")
            document.getElementById("notification").innerText = "상태를 선택해주세요.";
        else if(selectedStatus === "취소" && document.getElementById("reason").value.trim() === "")
            document.getElementById("notification").innerText = "취소 사유를 입력해주세요";
        else {
            fetch(`/business/program/${programNum}/booking`, {
                method: "PUT",
                headers: {
                    "Content-type": "application/json"
                },
                body: JSON.stringify(data)
            }).then((r) => {
                alert("변경이 완료되었습니다.");
                location.replace(url);
            })
        }
    }

    function checkAll(checkBox) {
        let c = document.querySelectorAll('input[name=listCheckbox]:not(:disabled)')
        for (let i = 0; i < c.length; i++)
            c[i].checked = checkBox.checked;
    }

    function setStatusValue(t) {
        if (t.value === "취소") {
            document.getElementById("enterReason").style.display = "block";
        }
        else
            document.getElementById("enterReason").style.display = "none";
    }

    function showSeatingChart() {
        let url = `/business/program/${programNum}/seat?date=${viewingDate}&time=${viewingTime}`;
        window.open(url, "좌석 현황", "width=800px, height=500px");
    }
</script>
</body>
</html>
