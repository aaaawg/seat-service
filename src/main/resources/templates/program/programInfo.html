<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="layout/head :: head(~{::link})">
    <link th:href="@{/css/programInfo.css}" href="../css/programInfo.css" rel="stylesheet">
</head>
<body>
<div th:replace="/layout/nav.html :: nav"></div>
<div class="container" style="max-width: 1000px">
    <div class="row programInfoDiv">
        <div class="programImgDiv col-3">
            <span th:if ="${file.filename != 'NoInImage'}">
                <img th:each="im : ${fileList}" th:src="@{'/files/' + ${im.filename}}" title=${im.origfilename}/>
            </span>
            <div class="noImg" th:unless="${file.filename != 'NoInImage'}"><i class="bi bi-image"></i></div>
        </div>
        <div class="programTextDiv col" style="position: relative;">
            <div id="tDiv">
                <span class="badge bg-secondary imgBadge" th:text="(${programInfo.type} == 'offline')?'대면':'비대면'"></span>
                <h2 th:text="${programInfo.title}"></h2>
            </div>
            <table class="table table-borderless">
                <tr>
                    <th style="width: 15%">대상</th>
                    <td th:if="${programInfo.target} == 'etc'" th:text="${programInfo.targetDetail}"></td>
                    <td th:unless="${programInfo.target} == 'etc'" th:text="${programInfo.target} == 'all'? '제한없음' : ${programInfo.targetDetail} + ' 거주'"></td>
                </tr>
                <tr>
                    <th>장소</th>
                    <td th:text="${programInfo.place}"></td>
                </tr>
                <tr>
                    <th>모집인원</th>
                    <td th:text="${programInfo.peopleNum} == -1? '무제한' : ${programInfo.peopleNum} + '명'"></td>
                </tr>
                <tr>
                    <th>신청기간</th>
                    <td th:text="${#dates.format(programInfo.startDate,'yyyy.MM.dd')} + ' ~ ' + ${#dates.format(programInfo.endDate, 'yyyy.MM.dd')}"></td>
                </tr>
                <tr>
                    <th>주최</th>
                    <td th:text="${programInfo.bizName}"></td>
                </tr>
                <tr>
                    <th>문의</th>
                    <td th:text="${programInfo.bizPhone}"></td>
                </tr>
            </table>
            <div th:if="${programInfo.bizUserId} == ${#authentication.name}" sec:authorize="hasRole('BIZ')" id="bizBtn">
                <button class="btn btn-outline-secondary btn-sm" th:onclick="|location.href='@{/business/program/update/{programNum}(programNum=${programInfo.programNum})}'|" type="button">내용 수정</button>
                <button id="changeForm" class="btn btn-outline-dark btn-sm" type="button">신청폼 수정</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row programDateDiv rounded-2">
            <div class="col" style="padding-right: 20px">
                <div style="margin-bottom: 5px">
                    <i class="bi bi-calendar4-event"></i>
                    <h5>날짜 선택</h5>
                </div>
                <ul id="selectDate" class="list-group">
                    <li class="list-group-item" th:each="i, viewing: ${programViewing}" th:if="${viewing.index == 0||(viewing.index > 0 && programViewing[viewing.index].viewingDate != programViewing[(viewing.index)-1].viewingDate)}" onclick="selectedDate(this.innerText)" th:text="${i.viewingDate}"></li>
                </ul>
            </div>
            <div class="col" style="padding-left: 20px; border-left: solid #c9c9c9 1px">
                <div style="margin-bottom: 5px">
                    <i class="bi bi-clock"></i>
                    <h5>시간 선택</h5>
                </div>
                <ul id="selectTime" class="list-group"></ul>
            </div>
            <div id="appDiv">
                <div th:if="${#dates.createToday().compareTo(programInfo.startDate) >= 0} and ${programInfo.endDate.compareTo(#dates.createToday()) >= 0} and !${#authorization.expression('hasRole(''' + 'BIZ' + ''')')}" class="row justify-content-end" style="padding-right: 10px; padding-top: 20px">
                    <div class="col" id="peopleCount" th:if="${programInfo.peopleNum} != -1"></div>
                    <button class="col-3 btn rounded-2" type="button" th:a="${#authorization.expression('isAuthenticated()')}" th:s="${programInfo.programNum}" onclick="openPopup(this.getAttribute('s'), this.getAttribute('a'))">신청하기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="infoMenu">
        <div><h5 class="activeDiv pDetail">상세정보</h5></div>
        <div><h5 class="qnaDetail" id="infoQna">Q&A</h5></div>
    </div>

    <div id="infoC">
        <div class="pDetail">
            <div id="programContents">
                <div th:utext="${programInfo.contents}"></div>
            </div>
            <hr>
            <div th:if="${programInfo.type == 'offline'}" id="mapDiv">
                <h5>장소</h5>
                <div id="map" style="width:400px; height:300px;"></div>
            </div>
        </div>

        <div class="qnaDetail hide">
            <div class="card" sec:authorize="isAuthenticated()">
                <div class="input-group card-body">
                    <textarea class="form-control" rows="2" id="qnaContent"></textarea>
                    <button class="btn btn-outline-secondary" type="button" onclick="addQnA()">등록</button>
                </div>
                <div class="card-footer text-end">
                    <input type="checkbox" class="form-check-input" id="chSecret">
                    <label class="form-check-label" for="chSecret">비밀글</label>
                </div>
            </div>

            <div id="qnaList">
                <th:block th:each="qna: ${qnaList}">
                    <div>
                        <span th:if="${qna.answer} == null" class="badge bg-secondary">미답변</span>
                        <span th:unless="${qna.answer} == null" class="badge bg-secondary">답변완료</span>
                        <span th:if="${qna.applicant}" class="badge bg-success">신청자</span>
                    </div>
                    <div>
                        <input type="hidden" class="qnaNum" th:value="${qna.qnaNum}">
                        <div th:if="${qna.secret}">
                            <div th:if="${programInfo.bizUserId} == ${#authentication.name} or ${qna.writer} == ${#authentication.name}">
                                <input type="hidden" class="qnaNum" th:value="${qna.qnaNum}">
                                <i class="bi bi-lock-fill"></i>
                                <p th:utext="${qna.question}"></p>
                                <span th:text="${#dates.format(qna.createDate,'yyyy.MM.dd HH:mm')}"></span><i th:if="${qna.writer} == ${#authentication.name}" class="bi bi-trash-fill" onclick="deleteQna(this)"></i>
                                <br>
                                <button class="showAnswerBtn btn btn-outline-secondary btn-sm" th:if="${qna.answer} != null">답변</button>

                                <div class="answerDiv rounded-2" th:if="${qna.answer} != null">
                                    <p th:utext="${qna.answer}"></p>
                                    <span th:text="${#dates.format(qna.answerDate,'yyyy.MM.dd HH:mm')}"></span>
                                </div>
                            </div>
                            <div th:unless="${programInfo.bizUserId} == ${#authentication.name} or ${qna.writer} == ${#authentication.name}"><i class="bi bi-lock-fill"></i>비밀글입니다.</div>
                        </div>
                        <div th:unless="${qna.secret}">
                            <input type="hidden" class="qnaNum" th:value="${qna.qnaNum}">
                            <p th:utext="${qna.question}"></p>
                            <span th:text="${#dates.format(qna.createDate,'yyyy.MM.dd HH:mm')}"></span><i th:if="${qna.writer} == ${#authentication.name}" class="bi bi-trash-fill" onclick="deleteQna(this)"></i>
                            <br>
                            <button class="showAnswerBtn btn btn-sm btn-outline-secondary" th:if="${qna.answer} != null">답변</button>
                            <div class="answerDiv rounded-2" th:if="${qna.answer} != null">
                                <p th:utext="${qna.answer}"></p>
                                <span th:text="${#dates.format(qna.answerDate,'yyyy.MM.dd HH:mm')}"></span>
                            </div>
                        </div>
                        <div th:if="${qna.answer} == null and ${programInfo.bizUserId} == ${#authentication.name}">
                            <button class="showEnterAnswerBtn btn btn-outline-secondary btn-sm">답변등록</button>
                            <div class="input-group enterAnswerDiv">
                                <textarea class="form-control" placeholder="답변을 입력해주세요." rows="2" id="qnaAnswer"></textarea>
                                <button class="btn btn-outline-secondary" type="button" onclick="addAnswer(this)">등록</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                </th:block>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=##&libraries=services"></script>
<!--<script th:inline="javascript">
    const p = [[${programInfo.place}]];
    let place = p.split(',', 1);

    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };

    // 지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // 주소-좌표 변환 객체를 생성합니다
    var geocoder = new kakao.maps.services.Geocoder();

    // 주소로 좌표를 검색합니다
    geocoder.addressSearch(place, function(result, status) {

        // 정상적으로 검색이 완료됐으면
        if (status === kakao.maps.services.Status.OK) {

            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

            // 결과값으로 받은 위치를 마커로 표시합니다
            var marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });
            marker.setMap(map);

            // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
            map.setCenter(coords);
        }
    });
</script>-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script th:inline="javascript">

    $(document).ready(function() {
        $(".infoMenu>div>h5").click(function() {
            $(".infoMenu>div>h5").removeClass("activeDiv");
            $("#infoC>div").removeClass("hide");

            $(this).addClass("activeDiv");

            if($(this).hasClass("pDetail")) {
                $("#infoC > .qnaDetail").addClass("hide");
            }
            else {
                $("#infoC > .pDetail").addClass("hide");
            }
        });

        $("#selectDate > li").click(function() {
            $("#selectDate > li").removeClass("activeli");
            $(this).addClass("activeli");
        });

        $(".answerDiv").hide();
        $(".enterAnswerDiv").hide();

        $(".showAnswerBtn").click(function () {
            $(this).next(".answerDiv").toggle();
        })

        $(".showEnterAnswerBtn").click(function () {
            $(".enterAnswerDiv").hide();
            $(this).next(".enterAnswerDiv").toggle();
        });
    });

    let sDate;
    let sTime;
    const pNum = [[${programInfo.programNum}]];
    const bookingCount = [[${bookingCount}]];

    const changeFormButton = document.getElementById("changeForm");
    changeFormButton.addEventListener("click", function() {
    if (bookingCount !== 0) {
        event.preventDefault();
        alert("신청자가 존재하여 수정이 불가능합니다.");
    }else{
        window.location.href = "/business/program/"+pNum+"/formEdit";
    }
  });

    function selectedDate(date) {
        sDate = date;
        const u = document.getElementById("selectTime");
        u.innerText = "";
        const list = [[${programViewing}]];
        for (let i = 0; i < list.length; i++) {
            if(date == list[i].viewingDate) {
                let tt = document.createElement("li");
                tt.className = "list-group-item";
                tt.innerText = list[i].viewingTime;
                tt.onclick = function selectedTime() {
                    sTime = this.innerText;
                };
                u.appendChild(tt);
            }
        }
        if([[${#dates.createToday().compareTo(programInfo.startDate) >= 0} and ${programInfo.endDate.compareTo(#dates.createToday()) >= 0}]])
            u.addEventListener("click", showPeopleCount);

        $("#selectTime > li").click(function() {
            $("#selectTime > li").removeClass("activeli");
            $(this).addClass("activeli");
        });
    }

    function openPopup(num, a) {
        if (a === "true") {
            if (sDate == null) {
                alert("날짜를 선택해주세요.");
            } else if (sTime == null) {
                alert("시간을 선택해주세요.");
            } else {
                let url = "/booking/" + num;
                window.open(url, "예약", "width=1025px, height=535px");
            }
        } else {
            const answer = confirm("로그인이 필요합니다.")
            if (answer)
                location.href = "/login";
        }
    }

    function selectedProgramInfo(t) {
        if (t === "date")
            return sDate;
        else if (t === "time")
            return sTime;
        else if (t === "title")
            return [[${programInfo.title}]];
        else if (t === "peopleNum")
            return [[${programInfo.peopleNum}]];
        else if(t === "endDate")
            return [[${programInfo.endDate}]];
    }

    function showPeopleCount() {
        let iHtml;
        const pNum = [[${programInfo.programNum}]];
        if ([[${programInfo.peopleNum}]] !== -1) {
            fetch(`/program/peopleCount?programNum=${pNum}&viewingDate=${sDate}&viewingTime=${sTime}`, {
            }).then((r) => {
                return r.text();
            }).then((r) => {
                let count = Number(r);
                if ([[${programInfo.peopleNum}]] === count) {
                    iHtml = "<span class='badge bg-secondary'>인원 마감</span>";
                } else
                    iHtml = "<span>(잔여 " + ([[${programInfo.peopleNum}]] - count) + "명)</span>";
                document.getElementById("peopleCount").innerHTML = iHtml;
            })
        }
    }

    function addQnA() {
        let chValue = document.getElementById("chSecret").checked;
        let programNum = [[${programInfo.programNum}]];
        const content = document.getElementById("qnaContent").value;
        let rContent = content.replace(/(?:\r\n|\r|\n)/g, '<br>');

        if(content.trim().length !== 0) {
            fetch(`/qna/${programNum}`, {
                method: "post",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "question": rContent,
                    "secret": chValue
                })
            }).then((r) => {
                if (r.ok) {
                    alert("등록되었습니다.");
                    document.getElementById("qnaContent").value = "";
                    document.getElementById("chSecret").checked = false;
                    location.replace(`/program/${pNum}`)
                } else
                    alert("등록에 실패하였습니다.");
            })
        } else {
            alert("내용을 입력해주세요.");
        }
    }

    function addAnswer(t) {
        const content = document.getElementById("qnaAnswer").value;
        let answer = content.replace(/(?:\r\n|\r|\n)/g, '<br>');
        const qnaNum = t.parentNode.parentNode.parentNode.querySelector(".qnaNum").value;
        if(content.trim().length !== 0) {
            fetch(`/answer/${qnaNum}`, {
                method: "post",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "answer": answer
                })
            }).then((r) => {
                if (r.ok) {
                    alert("등록되었습니다.");
                    location.replace(`/program/${pNum}`)
                } else
                    alert("등록에 실패하였습니다.");
            })
        } else {
            alert("내용을 입력해주세요.");
        }
    }

    function deleteQna(t) {
        const a = confirm("정말 삭제하시겠습니까?");
        const qnaNum = t.parentNode.parentNode.querySelector(".qnaNum").value;
        if(a) {
            fetch(`/qna/${qnaNum}`, {
                method: "delete",
            }).then((r) => {
                if (r.ok) {
                    alert("삭제되었습니다.");
                    location.replace(`/program/${pNum}`)
                } else
                    alert("삭제에 실패하였습니다.");
            })
        }
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<script type="text/javascript" src="/js/nav.js"></script>
</body>
</html>